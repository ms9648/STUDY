# CHAPTER 04 네트워크 계층: 데이터 평면
네트워크 계층은 서로 상호작용하는 데이터 평면과 제어 평면의 두 부분으로 나눌 수 있다. 

## 4.1 네트워크 계층 개요
각 라우터의 데이터 평면 역할은 입력 링크에서 출력 링크로 데이터그램을 전달하는 것이다. 

### 4.1.1 포워딩과 라우팅: 데이터 평면과 제어 평면
네트워크 계층의 근본적 역할은 송신 호스트에서 수신 호스트로 패킷을 전달하는 것이다. 다음은 네트워크 계층의 두 가지 중요 기능이다.
1. 포워딩(전달): 패킷이 라우터의 입력 링크에 도달했을 때 그 패킷을 적절한 출력 링크로 보내는 것. 포워딩은 데이터 평면에 구현된 하나의 기능이다.

2. 라우팅: 송신자가 수신자에게 패킷을 전송할 때 네트워크 계층이 **패킷 경로를 결정하는 것**. 이러한 경로를 계산하는 알고리즘을 라우팅 프로토콜이라 한다. 패킷 전송 라우팅은 네트워크 계층의 제어 평면에서 실행된다. 

라우터는 도착하는 패킷 헤더의 필드 값을 조사하여 패킷을 포워딩하는데, 이 값을 라우터의 포워딩 테이블의 내부 색인으로 사용한다. 포워딩 테이블 엔트리에 저장되어 있는 헤더의 값은 해당 패킷이 전달되어야 할 라우터의 외부 링크 인터페이스를 나타낸다.

#### 제어 평면: 전통적인 접근(Destination-based forwarding)
![Chap4_Classical_Control_plane](Chap4_Classical_Control_plane.PNG)
라우팅 프로토콜은 라우터의 포워딩 테이블의 내용을 결정한다. 라우팅 프로토콜은 **각각의 모든 라우터**에서 실행되며, 라우터는 포워딩과 라우팅 기능 모두 갖고 있어야 한다. 또, 모든 라우터는 다른 라우팅 구성요소를 가지고 있어 통신이 가능하다. 즉, 라우터 서로서로 상호작용을 하여 라우팅 알고리즘으로 포워딩 테이블을 작성하고 패킷은 이를 보고 목적지를 찾아간다.

#### 제어 평면: SDN(Software Defined Networking)
![Chap4_SDN_Control_plane](Chap4_SDN_Control_plane.PNG)
**원격 컨트롤러가 각 라우터의 CA(Control Agent)로부터 정보를 수집하여 포워딩 테이블을 작성**해서 개별 라우터가 이를 사용할 수 있도록 포워딩 테이블을 제공한다. 원격 컨트롤러가 포워딩 테이블을 계산/배분 하는 동안 **라우팅 기기는 포워딩만을 수행**한다. 라우터는 포워딩 테이블과 다른 라우팅 정보를 포함한 메시지를 원격 컨트롤러와 교환함으로써 소통한다.

> traditional한 방식은 IP 데이터그램의 목적지 IP 주소만을 보고 포워딩을 결정하지만 SDN방식은 목적지 IP 주소 뿐만 아니라 헤드의 관련된 기타 정보를 보고 포워딩을 결정한다.

### 4.1.2 네트워크 서비스 모델
네트워크 서비스 모델은 송수신 호스트 간 패킷 전소 특성을 정의한다.
네트워크 계층에서 제공할 수 있는 서비스들은 다음과 같다.
1. 보장된 전달: 패킷이 소스 호스트에서부터 목적지 호스트까지 도착하는 것을 보장한다.
2. 지연 제한 이내의 보장된 전달: 패킷의 전달 보장뿐만 아니라 호스트간의 특정 지연 제한안에 전달한다.
> 여기까지가 개별 데이터그램에 대한 서비스

3. 순서화 패킷 전달: 패킷이 목적지에 송신된 순서대로 도착하는 것을 보장한다.
4. 최소 대역폭 보장: 송신과 호스트 사이에 특정한 비트 속도의 전송 링크를 에뮬레이트한다
5. 보안 서비스: 모든 데이터그램들을 소스 호스트에서는 암호화, 목적지 호스트에서는 해독을 할 수 있게 하여 전송 계층의 모든 세그먼트들에 대해 기밀성을 제공하여야 한다.
> 여기는 일련의 데이터그램(하나의 어플리케이션 데이터)에 대한 서비스

인터넷 네트워크 계층은 최선형 서비스를 제공하는데, 최선형 서비스는 패킷을 보내는 순서대로 수신됨을 보장할 수 없을 뿐만 아니라, 목적지까지의 전송 자체도 보장될 수 없다. 이에 반해 ATM(Asynchronous Transfer Mode)이라는 기술(virtual circuit 방식-패킷(cell이라고 불린다)스위칭 방식)이 있다.

|Network Architecture|Service Model|Bandwidth|Loss|Order|Timing|Congestion feedback|
|-|-|-|-|-|-|-|
|Internet|best effort|none|no|no|no|no|
|ATM|CBR|constant rate|yes|yes|yes|no|
|ATM|VBR|guaranteed rate|yes|yes|yes|no congestion|
|ATM|ABR|guaranteed|no|yes|no|yes|
|ATM|UBR|none|no|yes|no|no|
## 4.2 라우터 내부에는 무엇이 있을까?
![Chap4_Router_Architecture](Chap4_Router_Architecture.PNG)

![Chap4_Router_Construction](Chap4_Router_Construction.PNG)
라우터의 4가지 요소는 다음과 같다.
1. 입력 포트: 제어 패킷(라우팅 프로토콜 정보를 전달하는 패킷)은 입력 포트에서 라우팅 프로세서로 전달된다. 
    - physical layer: **비트 단위**의 입력값을 받아들인다.
    - datalink layer: 입력 링크의 반대편에 있는 링크 계층과 상호작용하기 위해 필요한 링크 계층 기능을 수행한다.
    - network layer: IP 데이터그램의 헤더 값(목적지 IP주소)을 읽고 이를 포워딩 테이블을 참조하여 전달되는 라우터 출력 포트를 결정한다. 검색 기능 또한 수행한다. 네트워크 계층 내부에는 큐가 있어서 데이터그램이 포워딩 속도보다 빠르면 큐 내에 잠시 저장된다.

    > 물리계층에서 네트워크 계층까지 decapsulation해서 정보를 추출한다.

2. 스위칭 구조: 라우터의 입력 포트와 출력 포트를 연결한다. 라우터 내부에 포함되어 있다. -> 네트워크 라우터의 내부 네트워크

3. 출력 포트: 출력 포트는 스위칭 구조에서 수신한 패킷을 저장하고 필요한 링크 계층 및 물리적 계층 기능을 수행하여 출력 링크로 패킷을 전송한다. 링크가 양방향일 때 출력 포트는 일반적으로 동일한 링크의 입력 포트와 한 쌍을 이룬다.

4. 라우팅 프로세서: 라우팅 프로세서는 **제어 평면** 기능을 수행한다. SDN 라우터에서는 라우팅 프로세서는 원격 컨트롤러와 통신하여 원격 컨트롤러에서 계산된 **포워딩 테이블 항목**을 수신하고 라우터의 입력 포트에 이러한 항목을 제공한다.

라우터의 입력 포트, 출력 포트, 스위칭 구조는 거의 하드웨어로 구현된다. -> data plane으로 처리 속도가 중요하기 때문에 하드워에 적으로 구현된다. ns단위이다.

제어 평면(라우팅 프로세서)은 소프트웨어적으로 구현되며 ms단위이다.

### 4.2.1 입력 포트 처리 및 목적지 기반 전달
> Destination-based forwarding
라우터는 포워딩 테이블을 사용하여 도착 패킷이 스위칭 구조를 통해 전달되는 출력 포트를 검색한다. 포워딩 테이블은 라우팅 프로세서에서 계산되거나 업데이트되거나 원격 SDN 컨트롤러에서 수신된다. 포워딩 테이블에서 패킷의 목적지 주소 범위는 32비트 IP 주소의 경우 약 40억개의 주소가 있지만 프리픽스를 테이블의 엔트리와 대응시킴으로써 줄일 수 있다. 대응하는 엔트리가 존재하면 라우터는 패킷을 그 대응에 연관된 링크로 보낸다. 
만약 엔트리가 중복되어 대응되면 **최장 프리픽스 매칭 규칙** 을 적용한다. 즉, 테이블에서 가장 긴 대응 엔트리를 찾고, 여기에 연관된 링크 인터페이스로 패킷을 보낸다. 만약 길이도 같으면 먼저 대응된 엔트리의 값으로 패킷을 보낸다.

기가바이트 전송 속도에서 포워딩 테이블의 검색은 나노초 단위로 수행되어야 하기 때문에 빠른 검색 알고리즘이 필요하다. 실제로 TCAM(Ternary Content Addressable Memories)도 검색을 위해 자주 사용된다. 테이블의 엔트리 수와 무관하게 1 클럭 사이클 내에 검색을 완료할 수 있다.

> Cisco Catalyst는 1M 개의 라우팅 테이블 엔트리들이 TCAM에 저장되었다.

검색을 통해 패킷의 출력 포트가 결정되면 스위칭 구조로 보낼 수 있다. 일부 설계에서, 다른 입력 포트로부터의 패킷이 현재 스위칭 구조를 사용하고 있다면 패킷이 스위칭 구조에 들어가는 것을 일시적으로 차단할 수 있다. 차단된 패킷은 입력포트에서 대기하다가 다음 나중 시점에 스위칭 구조에 들어간다.

### 4.2.2 변환기
![Chap4_Switching_tech](Chap4_Switching_tech.PNG)
스위칭 기술은 여러 가지가 있다.
1. 메모리를 통한 교환: 
- 패킷이 도착하면 입력 포트는 라우팅 프로세서에게 인터럽트를 보내 패킷을 프로세서 메모리에 복사한다.
- 라우팅 프로세서는 헤더에서 대상 주소를 추출하여 포워딩 테이블에서 적절한 출력 포트를 찾은 다음 패킷을 출력 포트의 버퍼에 복사한다.

> 이 시나리오에서 메모리 대역폭이 초당 최대 B인 패킷을 메모리에 쓰거나 메모리에서 읽을 수 있는 경우 전체 전달 처리량(패킷이 입력 포트에서 출력 포트로 전송되는 총 속도)은 B/2보다 작아야 한다. 

> 또한 목적지 포트가 다른 경우라도 공유 시스템 버스를 통해 한 번에 하나의 메모리 읽기/쓰기 작업을 수행할 수 있기 때문에 **두 패킷을 동시에 전달할 수 없다**.

2. 버스를 통한 교환: 라우팅 프로세서의 개입 없이 공유 버스를 통해 직접 출력 포트로 패킷을 전송한다.
- 일반적으로 미리 준비된 입력 포트 스위치 내부 헤더가 로컬 출력 포트를 나타내는 패킷에게 전송되거나 버스에 패킷을 전송하여 수행된다.
- 모든 출력 포트에 패킷이 수신되지만 라벨과 일치하는 포트만 패킷을 유지한다.
- 한 번에 하나의 패킷만 버스를 통과할 수 있기 때문에 라우터의 교환 속도는 버스 속도에 의해 제한된다.
> 작은 규모에 사용될 수 있는 switching fabric의 구조이다.

3. Crossbar를 통한 교환

## 4.2.3 출력 포트 프로세싱
출력 포트의 메모리에 저장된 패킷을 가져와서 출력 링크를 통해 전송한다.

## 큐잉
### 입력 큐잉
![Chap4_HOL](Chap4_HOL.PNG)
switching 속도가 입력 포트로부터 패킷이 들어오는 속도보다 늦으면 큐에서 기다린다. 
- Head-of-the-Line(HOL) blocking: 같은 시간대에 같은 출력 포트로 가는 패킷이 2개가 있으면 한 입력 포트는 기다리게 되는데 이 때문에 놀고 있는 출력포트에 대한 패킷이 이동하지 못하게 되는 현상이다.

### 출력 큐잉
스위칭 구조에서 처리하는 속도가 전송 속도보다 빠를 경우에는 패킷이 쌓이기 때문에 datagram buffer에 큐가 필요하다. 이에 따라 **delay와 loss**가 발생할 수 있다.
스위칭 구조에서 변환되는 속도가 출력 포트의 속도보다 N배 빠를 경우 만약 스위칭 구조에서 모든 패킷이 하나의 출력포트로 향한다면 N개가 출력 포트의 큐에 대기하게 되고 하나가 처리되는 동안에 또 N개가 밀릴 수 있다. 즉, 대기 중인 패킷의 수가 출력 포트에서 사용 가능한 메모리를 소모할 만큼 충분히 많아질 수 있다.

## 4.2.5 패킷 스케줄링
scheduling discipline은 데이터그램 버퍼 내부에 패킷을 전송하는 순서를 결정한다. 
1. First-In-First-Out: 들어온 순서대로 내보낸다.
    - discard policy(큐가 가득찬 상태에서 패킷이 도착하면 어떤 패킷을 제거해야 하는가?)
        - tail drop: 새로 들어온 패킷을 제거한다.
        - priority: 우선순위에 따라 제거한다.
        - random: 임의로 제거한다.

2. Priority: 높은 우선순위를 가진 패킷을 먼저 보낸다.
    - 우선순위는 IP 출발지/목적지, 포트 번호에 따라 결정된다.

# 4.3 인터넷 프로토콜(IP)
네트워크 계층에는 IP Protocol(addressing 관련), ICMP protocol(IP 데이터그램을 전송할 때 에러 체킹 & 라우터 signaling->Traceroute), Routing protocol이 있다.

## 4.3.1 IPv4 데이터그램 형식
![Chap4_IPv4_Datagram_format](Chap4_IPv4_Datagram_format.PNG)
- 32비트(1 word, 4bytes) 주소를 사용한다.
- 버전 번호: 4비트로 데이터그램의 IP 프로토콜 버전을 명시한다. 이 값을 통해 나머지 필드를 어떻게 해석할지를 결정한다. ex) IPv4: 0100, IPv6: 0110
- 헤더 길이: 4비트로 IP 데이터그램에서 실제 페이로드(데이터)가 시작하는 곳을 결정한다.
- 서비스 타입: IPv4 헤더에 포함된 서비스타입(TOS) 비트는 서로 다른 유형의 IP 데이터그램을 구별한다. QOS(Quality of service) 기능을 제공한다.
- 데이터그램 길이: 바이트로 계산한 IP 데이터그램의 전체 길이이다. 16비트로 IP데이터그램의 이론상 최대 길이는 65535 바이트이다. 보통 1500바이트 이하이다.
- 16비트 식별자, 플래그, fragment offset: fragment와 관련된 필드
- TTL(Time-to-live): 네트워크에서 데이터그램이 무한히 순환하지 않도록 한다. 라우터가 데이터그램을 처리할 때마다 감소하도록 하며 시간 내 도착하지 못하면 버리게 하는 필드이다. TTL이 0이 되면 라우터가 데이터그램을 폐기한다. 폐기한 후 ICMP를 사용하여 source한테 에러 여부를 전달한다.
- 상위 계층 프로토콜: 데이터 필드가 어떤 프로토콜에 의해 작성된것인지 알려준다. 값 6은 TCP, 17은 UDP를 뜻한다. 이 필드는 일반적으로 IP 데이터그램이 최종 목적지에 도착했을 때만 사용된다.
- 헤더 체크섬: 헤더 부분에 대한 오류 체크를 위한 것이다.
- 옵션: 거의 사용되지 않는다.(가변적인 데이터) timestamp, record route, source routing(거쳐야할 라우터를 명시할 수 있다.)
- 데이터: TCP/UDP 세그먼트 or IP데이터그램이 들어간다.(OSPF, ICMP같은 것들도 들어갈 수 있다.)
> IP 데이터그램 안에 IP 데이터그램도 들어갈 수 있다.

> IP 데이터그램은 총 20바이트의 헤더를 가지며 데이터그램이 TCP 세그먼트를 전송하게 되면 총 40바이트의 헤더를 전송하게 되는 것이다.

### IP fragmentation, reassembly
링크 계층 프레임(2계층 프레임)이 전달할 수 있는 최대 데이터의 양을 MTU(Maximum Transmission Unit)라고 한다. ex) 이더넷: MTU = 1500
송-수신자 간의 경로를 따르는 각 링크가 서로 다른 링크 계층 프로토콜을 사용할 수 있고, 각 프로토콜이 서로 다른 MTU를 가질 수 있다.

각 라우터마다 다른 MTU를 가질 수 있으며 한 라우터의 MTU가 IP 데이터그램의 크기보다 작을 경우 전달할 수 없기 때문에 IP 데이터그램의 페이로드를 두 개 이상의 작은 IP 데이터그램으로 분할하고 각각의 분할한 조각들을 별도의 링크 계층 프레임으로 캡슐화해서 출력 링크로 보낸다. 이를 fragment라고 부른다.

각 fragment는 독립적인 datagram이다. 목적지에서 원래 형태로 재조립된다.

IP 데이터그램의 길이가 4000바이트이면 이는 헤더 + 데이터를 의미한다. 즉 헤더(20바이트) + 데이터(3980바이트)이다.

MTU가 1500바이트이면 1500 2개와 나머지가 되어야 한다. 따라서 다음과 같이 된다.
1500(20 + 1480)
1500(20 + 1480)
1040(20 + 1020)
따라서 1480 + 1480 + 1020 = 3980바이트의 데이터를 전달할 수 있게 된다.

플래그 비트: 마지막 fragment는 0이다. 나머지는 다 1이다.
오프셋: 앞의 fragment가 전달 된 데이터의 크기를 8로 나눈 값이다. 첫 번째 fragment의 offset은 0이고, 두 번째 fragment의 offset은 1480 / 8 = 185가 된다. 세 번째는 370이 된다.

목적지에서 재조립을 하게 되는데, 이를 위해 버퍼가 쓰인다. 순서대로 오지 않을 경우 버퍼에 저장되게 되는데, offset의 순서에 맞게 재조립된다. reassembly(재조립) timer가 있는데 이 시간 내에 도착하지 않으면 버려지게 된다.

## IPv4 주소체계
IP address: 32-bit, 호스트/라우터 인터페이스에 대한 식별자 역할을 한다.
Interface: 호스트/라우터와 physical link 사이의 경계 

라우터는 데이터그램을 수신하여 다른 링크로 전달해야 하므로 2개 이상의 연결된 링크(인터페이스)가 필요하다.