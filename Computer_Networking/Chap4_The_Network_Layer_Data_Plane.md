# CHAPTER 04 네트워크 계층: 데이터 평면
네트워크 계층은 서로 상호작용하는 데이터 평면과 제어 평면의 두 부분으로 나눌 수 있다. 

## 4.1 네트워크 계층 개요
각 라우터의 데이터 평면 역할은 입력 링크에서 출력 링크로 데이터그램을 전달하는 것이다. 

### 4.1.1 포워딩과 라우팅: 데이터 평면과 제어 평면
네트워크 계층의 근본적 역할은 송신 호스트에서 수신 호스트로 패킷을 전달하는 것이다. 다음은 네트워크 계층의 두 가지 중요 기능이다.
1. 포워딩(전달): 패킷이 라우터의 입력 링크에 도달했을 때 그 패킷을 적절한 출력 링크로 보내는 것. 포워딩은 데이터 평면에 구현된 하나의 기능이다.

2. 라우팅: 송신자가 수신자에게 패킷을 전송할 때 네트워크 계층은 패킷 경로를 결정하는 것. 이러한 경로를 계산하는 알고리즘을 라우팅 프로토콜이라 한다. 패킷 전송 라우팅은 네트워크 계층의 제어 평면에서 실행된다. 

라우터는 도착하는 패킷 헤더의 필드 값을 조사하여 패킷을 포워딩하는데, 이 값을 라우터의 포워딩 테이블의 내부 색인으로 사용한다. 포워딩 테이블 엔트리에 저장되어 있는 헤더의 값은 해당 패킷이 전달되어야 할 라우터의 외부 링크 인터페이스를 나타낸다.

#### 제어 평면: 전통적인 접근
![Chap4_Classical_Control_plane](Chap4_Classical_Control_plane.PNG)
라우팅 프로토콜은 라우터의 포워딩 테이블의 내용을 결정한다. 라우팅 프로토콜은 각각의 모든 라우터에서 실행되며, 라우터는 포워딩과 라우팅 기능 모두 갖고 있어야 한다. 또, 모든 라우터는 다른 라우팅 구성요소를 가지고 있어 통신이 가능하다. 즉, 라우터 서로서로 상호작용을 하여 라우팅 알고리즘으로 포워딩 테이블을 작성하고 패킷은 이를 보고 목적지를 찾아간다.

#### 제어 평면: SDN(Software Defined Networking)
![Chap4_SDN_Control_plane](Chap4_SDN_Control_plane.PNG)
원격 컨트롤러가 포워딩 테이블을 작성해서 개별 라우터가 이를 사용할 수 있도록 포워딩 테이블을 제공한다. 원격 컨트롤러가 포워딩 테이블을 계산/배분 하는 동안 라우팅 기기는 포워딩만을 수행한다. 라우터는 포워딩 테이블과 다른 라우팅 정보를 포함한 메시지를 원격 컨트롤러와 교환함으로써 소통한다.

### 4.1.2 네트워크 서비스 모델
네트워크 서비스 모델은 송수신 호스트 간 패킷 전소 특성을 정의한다.
네트워크 계층에서 제공할 수 있는 서비스들은 다음과 같다.
1. 보장된 전달: 패킷이 소스 호스트에서부터 목적지 호스트까지 도착하는 것을 보장한다.
2. 지연 제한 이내의 보장된 전달: 패킷의 전달 보장뿐만 아니라 호스트간의 특정 지연 제한안에 전달한다.
> 여기까지가 개별 데이터그램에 대한 서비스
3. 순서화 패킷 전달: 패킷이 목적지에 송신된 순서로 도착하는 것을 보장한다.
4. 최소 대역폭 보장: 송신과 호스트 사이에 특정한 비트 속도의 전송 링크를 에뮬레이트한다
5. 보안 서비스: 모든 데이터그램들을 소스 호스트에서는 암호화, 목적지 호스트에서는 해독을 할 수 있게 하여 전송 계층의 모든 세그먼트들에 대해 기밀성을 제공하여야 한다.
> 여기는 일련의 데이터그램에 대한 서비스

인터넷 네트워크 계층은 최선형 서비스를 제공하는데, 최선형 서비스는 패킷을 보내는 순서대로 수신됨을 보장할 수 없을 뿐만 아니라, 목적지까지의 전송 자체도 보장될 수 없다. 이에 반해 ATM(Asynchronous Transfer Mode)이라는 기술(virtual circuit 방식-패킷스위칭을 사용한다.)이 있다. ATM은 

## 4.2 라우터 내부에는 무엇이 있을까?
![Chap4_Router_Architecture](Chap4_Router_Architecture.PNG)
라우터의 4가지 요소는 다음과 같다.
1. 입력 포트: 입력 포트의 젤 왼쪽 상자 & 출력 포트의 젤 오른쪽 상자로, 라우터로 들어오는 입력 링크의 물리계층 기능을 수행한다. 또, 입력/출력 포트의 중간 상자는 입력 링크의 반대편에 있는 링크 계층과 상호 운용하기 위해 필요한 링크 계층 기능을 수행한다. 입력 포트의 마지막 상자는 검색 기능을 수행하는데, 여기서 포워딩 테이블을 참조하여 도착된 패킷이 스위칭 구조를 통해 전달되는 라우터 출력 포트를 결정한다. 제어 패킷(라우팅 프로토콜 정보를 전달하는 패킷)은 입력 포트에서 라우팅 프로세서로 전달된다. 

2. 스위칭 구조: 라우터의 입력 포트와 출력 포트를 연결한다. 라우터 내부에 포함되어 있다. -> 네트워크 라우터의 내부 네트워크

3. 출력 포트: 출력 포트는 스위칭 구조에서 수신한 패킷을 저장하고 필요한 링크 계층 및 물리적 계층 기능을 수행하여 출력 링크로 패킷을 전송한다. 링크가 양방향일 때 출력 포트는 일반적으로 동일한 링크의 입력 포트와 한 쌍을 이룬다.

4. 라우팅 프로세서: 라우팅 프로세서는 제어 평면 기능을 수행한다. SDN 라우터에서는 라우팅 프로세서는 원격 컨트롤러와 통신하여 원격 컨트롤러에서 계산된 포워딩 테이블 항복을 수신하고 라우터의 입력 포트에 이러한 항목을 설치한다.

라우터의 입력 포트, 출력 포트, 스위칭 구조는 거의 하드웨어로 구현된다. 

### 4.2.1 입력 포트 처리 및 목적지 기반 전달
라우터는 포워딩 테이블을 사용하여 도착 패킷이 스위칭 구조를 통해 전달되는 출력 포트를 검색한다. 포워딩 테이블은 라우팅 프로세서에서 계산되거나 업데이트되거나 원격 SDN 컨트롤러에서 수신된다. 포워딩 테이블에서 패킷의 목적지 주소 범위는 32비트 IP 주소의 경우 약 40억개의 주소가 있지만 프리픽스를 테이블의 엔트리와 대응시킴으로써 줄일 수 있다. 대응하는 엔트리가 존재하면 라우터는 패킷을 그 대응에 연관된 링크로 보낸다. 만약 앞 3개의 엔트리와 대응하지 않으면 **최장 프리픽스 매칭 규칙** 을 적용한다. 즉, 테이블에서 가장 긴 대응 엔트리를 찾고, 여기에 연관된 링크 인터페이스로 패킷을 보낸다.

기가바이트 전송 속도에서 포워딩 테이블의 검색은 나노초 단위로 수행되어야 하기 때문에 빠른 검색 알고리즘이 필요하다. 실제로 TCAM(Ternary Content Addressable Memories)도 검색을 위해 자주 사용된다. TCAM을 사용하면 32비트 IP주소가 메모리에 제공되며, 이 주소는 본질적으로 일정 시간 동안 해당 주소에 대한 포워딩 테이블 항목의 내용을 반환한다.

검색을 통해 패킷의 출력 포트가 결정되면 스위칭 구조로 보낼 수 있다. 일부 설계에서, 다른 입력 포트로부터의 패킷이 현재 스위칭 구조를 사용하고 있다면 패킷이 스위칭 구조에 들어가는 것을 일시적으로 차단할 수 있다. 차단된 패킷은 입력포트에서 대기하다가 다음 나중 시점에 스위칭 구조에 들어간다.

### 4.2.2 변환기
![Chap4_Switching_tech](Chap4_Switching_tech.PNG)
스위칭 기술은 여러 가지가 있다.
1. 메모리를 통한 교환: 
- 초기의 라우터는 CPU(라우팅 프로세서)를 직접 제어해서 입력 포트와 출력 포트 사이에서 패킷을 스위칭하는 전통적인 컴퓨터이다. 
- 입력 포트와 출력 포트는 전통적인 운영 체제에서 전통적인 I/O 장치처럼 작동한다. 
- 패킷이 도착하면 입력 포트는 라우팅 프로세서에게 인터럽트를 보내 패킷을 프로세서 메모리에 복사한다.
- 라우팅 프로세서는 헤더에서 대상 주소를 추출하여 포워딩 테이블에서 적절한 출력 포트를 찾은 다음 패킷을 출력 포트의 버퍼에 복사한다.
> 이 시나리오에서 메모리 대역폭이 초당 최대 B인 패킷을 메모리에 쓰거나 메모리에서 읽을 수 있는 경우 전체 전달 처리량(패킷이 입력 포트에서 출력 포트로 전송되는 총 속도)은 B/2보다 작아야 한다. 

> 또한 목적지 포트가 다른 경우라도 공유 시스템 버스를 통해 한 번에 하나의 메모리 읽기/쓰기 작업을 수행할 수 있기 때문에 **두 패킷을 동시에 전달할 수 없다**.

2. 버스를 통한 교환: 라우팅 프로세서의 개입 없이 공유 버스를 통해 직접 출력 포트로 패킷을 전송한다.
- 일반적으로 미리 준비된 입력 포트 스위치 내부 헤더가 로컬 출력 포트를 나타내는 패킷에게 전송되거나 버스에 패킷을 전송하여 수행된다.